<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Milkdromeda Search</title>
  <meta name="description" content="Search Milkdromeda — Google-like UI with AI Overview powered by Meilisearch and an AI service." />
  <style>
    /* Google-like centered search page with results + AI overview */
    :root {
      --bg: #ffffff;
      --accent: #1a73e8;
      --muted: #6b7280;
      --text: #202124;
      font-family: "Roboto", Inter, Arial, sans-serif;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text)}
    .wrap{max-width:780px;margin:80px auto;text-align:center;padding:0 20px;box-sizing:border-box}
    .brand{font-size:42px;font-weight:700;color:var(--accent);letter-spacing:-1px;margin-bottom:18px}
    .search-row{display:flex;gap:10px;justify-content:center;margin-bottom:12px}
    .search-input{flex:0 1 60%;padding:14px 18px;border:1px solid #dfe1e5;border-radius:24px;font-size:16px;box-shadow:0 1px 2px rgba(0,0,0,0.05)}
    .btn{padding:10px 14px;border-radius:8px;border:0;background:var(--accent);color:#fff;font-weight:600;cursor:pointer}
    .hint{color:var(--muted);font-size:13px;margin-bottom:22px}

    .content{display:flex;gap:28px;align-items:flex-start;justify-content:center}
    .main{flex:1;max-width:640px;text-align:left}
    .overview{background:#f8f9fa;padding:14px;border-radius:8px;border:1px solid #e6e6e6;margin-bottom:14px}
    .overview h3{margin:0 0 8px 0;font-size:16px;color:#2b2b2b}
    .overview p{margin:0;color:var(--muted)}

    .results{display:flex;flex-direction:column;gap:12px}
    .result{padding:12px;border-radius:8px;border:1px solid #eee;background:#fff}
    .result .title{color:var(--accent);font-weight:700;margin-bottom:6px}
    .result .desc{color:var(--muted);font-size:14px}

    .sidebar{width:260px}
    .footer{margin-top:32px;color:var(--muted);font-size:13px;text-align:center}
    @media (max-width:900px){ .content{flex-direction:column} .sidebar{width:100%} .search-input{flex-basis:68%} }
  </style>
</head>
<body>
  <main class="wrap" role="main">
    <div class="brand">Milkdromeda</div>

    <div class="search-row" role="search" aria-label="Search">
      <input id="q" class="search-input" placeholder="Search Milkdromeda (e.g., Blade Ball, AFK farm...)" />
      <button id="searchBtn" class="btn" aria-label="Search">Search</button>
    </div>

    <div class="hint">Press Enter to search • AI overview above results</div>

    <div class="content">
      <section class="main" aria-live="polite">
        <div id="overview" class="overview" style="display:none">
          <h3>AI Overview</h3>
          <p id="overviewText"></p>
        </div>

        <div id="results" class="results"></div>
      </section>

      <aside class="sidebar" aria-hidden>
        <div style="padding:12px;border-radius:8px;border:1px solid #eee;background:#fff">
          <strong style="display:block;margin-bottom:8px">Quick actions</strong>
          <div style="display:flex;flex-direction:column;gap:8px">
            <button id="downloadBtn" style="padding:8px;border-radius:6px;border:1px solid #e6e6e6;background:#fff;cursor:pointer">Download JSON</button>
            <button id="healthBtn" style="padding:8px;border-radius:6px;border:1px solid #e6e6e6;background:#fff;cursor:pointer">Check API Health</button>
          </div>
        </div>
      </aside>
    </div>

    <div class="footer">© <span id="year"></span> Milkdromeda Studios</div>
  </main>

  <script>
    // Frontend wiring — calls the backend deployed at the same origin
    // If backend is on a different origin, set API_BASE to that origin URL.
    const API_BASE = ""; // "" means same origin, or "https://your-backend.onrender.com"

    const qEl = document.getElementById("q");
    const btn = document.getElementById("searchBtn");
    const resultsEl = document.getElementById("results");
    const overviewEl = document.getElementById("overview");
    const overviewTextEl = document.getElementById("overviewText");
    const healthBtn = document.getElementById("healthBtn");
    const downloadBtn = document.getElementById("downloadBtn");
    document.getElementById("year").textContent = new Date().getFullYear();

    function escapeHtml(s){ if(!s && s !== 0) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    async function safeJsonFetch(path, body=null) {
      const url = (API_BASE || "") + path;
      const opts = body ? {
        method: 'POST',
        headers: { 'Accept':'application/json','Content-Type':'application/json' },
        body: JSON.stringify(body)
      } : { method: 'GET' };
      const res = await fetch(url, opts);
      if (res.status === 204) return null;
      const text = await res.text().catch(()=>null);
      if (!text) return null;
      try { return JSON.parse(text); } catch(e) { return { text }; }
    }

    function renderResults(items) {
      resultsEl.innerHTML = "";
      if (!items || items.length === 0) {
        resultsEl.innerHTML = '<div style="color:#6b7280">No results</div>';
        return;
      }
      items.forEach(it => {
        const title = it.title || it.name || it.id || "Untitled";
        const desc = it.description || it.snippet || it.summary || "";
        const div = document.createElement("div");
        div.className = "result";
        div.innerHTML = `<div class="title">${escapeHtml(title)}</div>` + (desc ? `<div class="desc">${escapeHtml(desc)}</div>` : "");
        resultsEl.appendChild(div);
      });
    }

    async function doSearch() {
      const q = qEl.value.trim();
      if (!q) return;
      // clear UI
      overviewEl.style.display = "none";
      overviewTextEl.textContent = "";
      renderResults([]);

      // 1) fetch search results
      const search = await safeJsonFetch("/api/search", { query: q, index: "documents", limit: 12 }) || {};
      const hits = search.results || [];

      renderResults(hits);

      // 2) fetch AI overview (non-blocking)
      overviewEl.style.display = "block";
      overviewTextEl.textContent = "Generating overview...";
      const ov = await safeJsonFetch("/api/overview", { query: q });
      const text = ov?.result || ov?.summary || ov?.text || ov?.message || "No overview returned.";
      overviewTextEl.textContent = text;
    }

    btn.addEventListener("click", doSearch);
    qEl.addEventListener("keydown", (e) => { if (e.key === "Enter") doSearch(); });

    healthBtn.addEventListener("click", async () => {
      try {
        const h = await safeJsonFetch("/api/health");
        alert("Backend health: " + (h?.status || JSON.stringify(h)));
      } catch (err) { alert("Health check failed: " + (err?.message || err)); }
    });

    downloadBtn.addEventListener("click", () => {
      const results = Array.from(resultsEl.querySelectorAll(".result")).map(n => ({
        title: n.querySelector(".title")?.textContent || "",
        desc: n.querySelector(".desc")?.textContent || ""
      }));
      const overview = overviewTextEl.textContent || "";
      const blob = new Blob([JSON.stringify({ overview, results }, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "results.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
    });
  </script>
</body>
</html>
